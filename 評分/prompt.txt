我的前端會發送請求 並且附帶session_id 我需要實作
透過session_id 取得chatlog.db資料庫中的chatlog 資料表中該session的所有對話
將這些對話按照時間順序整理成
User(醫生):先生(小姐)您好，請坐
Agent(病人):你好，謝謝。
.
.
.

整理完之後 我還要搭上prompt去丟給本地 ollama gemma3:12b去讓他評分

檢查日期為開啟這個測驗的日期 加上 agentsetting的時間 

# --- 評分標準 (RUBRIC) ---
RUBRIC = {
    "檢閱藥歷": {
        "能詢問患者是否有使用此類藥物經驗(2 分)": "請問您之前有使用過清腸劑(藥)嗎？",
        "知道如何查閱患者目前用藥（4 分）": "請問您目前還有沒有服用其他藥物，如緩解便秘藥物、抗血小板、降血糖(胰島素)或抗凝血劑等用藥？是本院用藥還是有其他院外用藥？"
    },
    "醫療面談": {
        "向病人問好（1 分）": "先生/小姐，您好，請坐。",
        "請病人坐下（1 分）": "請坐。",
        "確認是否本人使用（1 分）": "請問是您本人要用的嗎？",
        "適切發問及引導以獲得正確且足夠的訊息（3 分）": "請問先生(小姐)要詢問什麼問題? / 請問這次大腸鏡檢查，是選擇做'一般/健保'還是'無痛'大腸鏡檢查? / 請問醫師幫我們安排哪一天做大腸鏡檢查(日期和時間)呢? / 請問繳費的費用約略是多少錢?",
        "對病人情緒及肢體語言能有適當的回應（0 分）": "(此項目第一階段暫不評估)"
    },
    "諮商衛教": {
        "說明藥物開立目的（0.5 分)": "醫師開立的清腸劑(藥)藥名是'保可淨'，主要作用是讓腸道能完全清乾淨，以利醫師進行腸鏡檢查。",
        "有註記服藥日期及相關時間點（1 分)": "我會幫您把服藥日期及時間註記在您的衛教單張上(口頭說明服藥時間亦可)。",
        "說明藥物使用時機及方式（1 分)": "請將一包『保可淨』散劑倒入裝有150c.c.常溫白開水的杯子中，攪拌至少5分鐘至粉劑完全溶解，然後立即喝完。",
        "說明水分補充方式及清腸理想狀態（1 分)": "服完藥液間隔一小時後，就要開始補充水分，總共會補充水分2000c.c.以上...持續觀察糞水狀態，直至為淡黃清澈液體。",
        "說明開始作用時間及平均時數（0.5 分)": "通常服藥2-3小時後會開始出現腹瀉之清腸反應。",
        "確認是否進行無痛麻醉（1 分)": "請問這次大腸鏡檢查是做一般大腸鏡檢查還是無痛大腸鏡檢查？",
        "能說明禁水時間（1 分)": "若是一般大腸鏡檢查，檢查前2小時之內，就不可再喝水。",
        "有詢問是否有使用降血糖或防栓塞藥物（0.5 分)": "請問先生(小姐)目前還有沒有服用其他藥物，如緩解便秘藥物、抗血小板、降血糖(胰島素)或抗凝血劑等用藥？",
        "能做簡易飲食衛教（1.5 分)": "檢查前三天要低渣飲食，不可以吃奶製品、起士、蔬菜水果；檢查前一天則是無渣流質飲食。"
    },
    "組織效率": {
        "按優先順序處置(衛教內容依順序執行)（6 分)": "衛教內容依順序執行，例如：飲食衛教 → 第一劑清腸劑衛教 → 第二劑清腸劑衛教 → 禁水衛教 → 其他藥物衛教。"
    },
    "臨床判斷": {
        "能依病人狀況判斷服藥時間（1.5 分)": "範例：根據檢查時間（如上午 12:00），判斷第一劑（下午 5 點）和第二劑（凌晨 7 點）的服藥時間。",
        "能依病人狀況判斷禁水時間（1.5 分)": "範例：根據檢查類型（一般/無痛），判斷具體禁水時間。",
        "能依檢查時間判斷早上服藥時間點（1.5 分)": "若檢查時間為下午（中午 12 點後，含 12 點），服藥時間為凌晨 7 點。",
        "能判斷病人是否有特殊藥物（降血糖/防栓塞/便祕藥物）（1 分)": "學員詢問並識別出高血壓藥物和緩解便秘藥物。",
        "能依病人狀況正確說明特殊藥物是否需停藥或續用（1.5 分)": "高血壓藥物請繼續服用，用少量開水服下，不要停藥；緩解便秘藥物也請繼續服用，不要停藥。"
    }
}


因為會需要
回答正確的部分+答對的部分句子
回答錯誤的部分+哪裡不正確

所以這部分就要等到評分完結束之後才能做

然後在score summary的prompt送出之間 還需要多做一個時間的計算
還有使用者在衛教順序有沒有搞錯



在ChatView.vue中 當使用者進行完對話 按下結束對話按鈕後(finishChat) 就將username與session_id 傳送給後端

此時後端的Scoring.py就需要先取得chatlog.db資料庫中的chatlog 資料表中該session的所有話並將這些對話按照時間順序整理成 

"User(醫生):先生(小姐)您好，請坐 

Agent(病人):你好，謝謝。"

接著要搭配我設計的prompt+AgentSetting資料+我設計的評分標準送入ollama llm 中

並將回應結果用成json的方式回傳 每個主題的分數以及總分 要存入sessionid_score 這個資料表中

在此同時 會使用另一段我所設計的prompt+AgentSetting



"""你是一位經驗豐富的醫護衛教指導老師。
請根據以下「病人基本資訊」、「學員衛教文本」、詳細的「評估報告」、「預期衛教時間軸」和「學員實際提及的時間軸」，針對學員的表現，為每個評分類別（特別是得分較低的類別）提供具體、可操作的改善建議。

請注意：
- 改善建議應著重於如何提高學員在未來衛教中的表現。
- 建議應具體到語句、行為或知識點。
- 避免空泛的建議。

<病人基本資訊>
{patient_info_context}
</病人基本資訊>

<學員衛教文本>
{student_text}
</學員衛教文本>

<評估報告>
{evaluation_report_str}
</評估報告>

<預期衛教時間軸>
此時間軸基於病人的檢查時間精確計算，代表衛教內容中應提及的正確時間點和事件，可作為標準答案或參考順序：
{expected_timeline_str}
</預期衛教時間軸>

<學員實際提及的時間軸>
以下是從學員衛教文字稿中提取出的事件時間軸。請參考學員實際提及的時間點和事件，判斷其是否正確或符合要求：
{student_timeline_str}
</學員實際提及的時間軸>

請提供分點說明，例如：

**總體表現評語:** [學員的整體表現概述，優點和不足]

**改善建議:**
**1. [評分類別名稱]** (得分: [學員該類別得分]/[該類別總分])
   - 建議1: [具體建議，例如應說什麼、怎麼做，可舉例]
   - 建議2: [具體建議]
**2. [評分類別名稱]** (得分: [學員該類別得分]/[該類別總分])
   - 建議1: ...
"""

輸入prompt 關於agent資訊的部分 我感覺他好像找不太到
靠北 我的資訊 並沒有說明檢查類型 無痛跟一般的關係 所以他這邊才沒辦法表現



"檢閱藥歷": {
    "能詢問患者是否有使用此類藥物經驗": "請問您之前有使用過清腸劑(藥)嗎？",
    "知道如何查閱患者目前用藥": "請問您目前還有沒有服用其他藥物，如緩解便秘藥物、抗血小板、降血糖(胰島素)或抗凝血劑等用藥？是本院用藥還是有其他院外用藥？"
},
"醫療面談": {
    "向病人問好": "先生/小姐，您好，請坐。",
    "請病人坐下": "請坐。",
    "確認是否本人使用": "請問是您本人要用的嗎？",
    "適切發問及引導以獲得正確且足夠的訊息": "請問先生(小姐)要詢問什麼問題? / 請問這次大腸鏡檢查，是選擇做'一般/健保'還是'無痛'大腸鏡檢查? / 請問醫師幫我們安排哪一天做大腸鏡檢查(日期和時間)呢? / 請問繳費的費用約略是多少錢?",
    "對病人情緒及肢體語言能有適當的回應": "(此項目第一階段暫不評估)"
},
"諮商衛教": {
    "說明藥物開立目的分": "醫師開立的清腸劑(藥)藥名是'保可淨'，主要作用是讓腸道能完全清乾淨，以利醫師進行腸鏡檢查。",
    "有註記服藥日期及相關時間點": "我會幫您把服藥日期及時間註記在您的衛教單張上(口頭說明服藥時間亦可)。",
    "說明藥物使用時機及方式": "請將一包『保可淨』散劑倒入裝有150c.c.常溫白開水的杯子中，攪拌至少5分鐘至粉劑完全溶解，然後立即喝完。",
    "說明水分補充方式及清腸理想狀態": "服完藥液間隔一小時後，就要開始補充水分，總共會補充水分2000c.c.以上...持續觀察糞水狀態，直至為淡黃清澈液體。",
    "說明開始作用時間及平均時數分": "通常服藥2-3小時後會開始出現腹瀉之清腸反應。",
    "確認是否進行無痛麻醉": "請問這次大腸鏡檢查是做一般大腸鏡檢查還是無痛大腸鏡檢查？",
    "能說明禁水時間": "若是一般大腸鏡檢查，檢查前2小時之內，就不可再喝水。",
    "有詢問是否有使用降血糖或防栓塞藥物分": "請問先生(小姐)目前還有沒有服用其他藥物，如緩解便秘藥物、抗血小板、降血糖(胰島素)或抗凝血劑等用藥？",
    "能做簡易飲食衛教分": "檢查前三天要低渣飲食，不可以吃奶製品、起士、蔬菜水果；檢查前一天則是無渣流質飲食。"
},
"組織效率": {
    "按優先順序處置(衛教內容依順序執行)": "衛教內容依順序執行，例如：飲食衛教 → 第一劑清腸劑衛教 → 第二劑清腸劑衛教 → 禁水衛教 → 其他藥物衛教。"
},
"臨床判斷": {
    "能依病人狀況判斷服藥時間分": "範例：根據檢查時間（如上午 12:00），判斷第一劑（下午 5 點）和第二劑（凌晨 7 點）的服藥時間。",
    "能依病人狀況判斷禁水時間分": "範例：根據檢查類型（一般/無痛），判斷具體禁水時間。",
    "能依檢查時間判斷早上服藥時間點分": "若檢查時間為下午（中午 12 點後，含 12 點），服藥時間為凌晨 7 點。",
    "能判斷病人是否有特殊藥物（降血糖/防栓塞/便祕藥物）": "學員詢問並識別出高血壓藥物和緩解便秘藥物。",
    "能依病人狀況正確說明特殊藥物是否需停藥或續用分": "高血壓藥物請繼續服用，用少量開水服下，不要停藥；緩解便秘藥物也請繼續服用，不要停藥。"
}

我們這邊只分成 沒有達成 達成一半 完全達成
假設這個評分項目的佔據分數只有0.5分 如果只達成一半 就是沒有達成 向下取整
資料庫欄位
評分類別 評分項目 佔據分數 範例答案



