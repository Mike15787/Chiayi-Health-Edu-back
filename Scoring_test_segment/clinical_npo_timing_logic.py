import asyncio
import os
import sys

# 1. è¨­å®šè·¯å¾‘èˆ‡ç’°å¢ƒè®Šæ•¸ (å‡è¨­ utils åœ¨åŒä¸€å±¤ç›®éŒ„)
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
os.environ["LLM_PROVIDER"] = "ollama"

try:
    from utils import generate_llm_response
except ImportError:
    print("éŒ¯èª¤: æ‰¾ä¸åˆ° utils.pyï¼Œè«‹ç¢ºèªè©²æª”æ¡ˆå­˜åœ¨æ–¼åŒä¸€ç›®éŒ„ä¸‹ã€‚")
    sys.exit(1)

# è¨­å®šæ¨¡å‹åç¨± (ä¾æ“šæ‚¨çš„æè¿°è¨­å®šç‚º gemma3:12b)
MODEL_NAME = "gemma3:12b"

# --- æ¸¬è©¦ç”¨çš„å°è©±ç´€éŒ„ ---
# è¨­å®šæƒ…å¢ƒï¼šä¸€èˆ¬æª¢æŸ¥ï¼Œæ™‚é–“æ—©ä¸Š 10 é»
# é æœŸé‚è¼¯ï¼šå‰ 3 å°æ™‚ç¦æ°´ (10-3 = 7é»)
TEST_CONTEXT = """
å­¸å“¡: æ‚¨å¥½ï¼Œç¢ºèªä¸€ä¸‹æ‚¨çš„æª¢æŸ¥æ™‚é–“æ˜¯æ’åœ¨ç•¶å¤©æ—©ä¸Šçš„10é»é˜ã€‚
ç—…æ‚£: æ˜¯çš„ï¼Œæ²’éŒ¯ã€‚
å­¸å“¡: å› ç‚ºæ‚¨åšçš„æ˜¯ä¸€èˆ¬æª¢æŸ¥ï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦åœ¨æª¢æŸ¥å‰3å°æ™‚é–‹å§‹ç¦æ°´ã€‚
ç—…æ‚£: å¥½çš„ï¼Œé‚£å¤§æ¦‚å¹¾é»ä¸èƒ½å–ï¼Ÿ
å­¸å“¡: ç¨å¾®è¨ˆç®—ä¸€ä¸‹ï¼Œæª¢æŸ¥ç•¶å¤©æ—©ä¸Š7é»é–‹å§‹ç¦æ°´ï¼Œä¹‹å¾Œå°±è«‹ä¸è¦å†å–ä»»ä½•æ°´äº†ã€‚
ç—…æ‚£: å¥½çš„ï¼Œæ—©ä¸Š7é»å¾Œä¸å–æ°´ã€‚
"""

# --- å››å€‹æ¸¬è©¦ Prompt å®šç¾© ---
CHECK_LIST = [
    {
        "key": "general_check_duration",
        "title": "æ¸¬è©¦ 1: ä¸€èˆ¬æª¢æŸ¥ (å‰3å°æ™‚)",
        "description": "æª¢æŸ¥æ˜¯å¦å‘ŠçŸ¥å‰3å°æ™‚ç¦æ°´",
        "prompt_template": """
    ä½ ç¾åœ¨çš„ä»»å‹™æ˜¯åˆ¤æ–·ä»¥ä¸‹å°è©±ç´€éŒ„
    å­¸å“¡æ˜¯å¦æœ‰æ˜ç¢ºå‘ŠçŸ¥ å¾æª¢æŸ¥å‰3å€‹å°æ™‚å‰é–‹å§‹ç¦æ°´
        
    [å°è©±ç´€éŒ„]: {conversation_context}
        
    ç¬¦åˆè¼¸å‡º "1"ï¼Œä¸ç¬¦åˆæˆ–æœªæåŠè¼¸å‡º "0" ä¸è¦è¼¸å‡ºé™¤äº†æ•¸å­—ä»¥å¤–çš„æ–‡å­—
"""
    },
    {
        "key": "painless_check_duration",
        "title": "æ¸¬è©¦ 2: ç„¡ç—›æª¢æŸ¥ (å‰2å°æ™‚)",
        "description": "æª¢æŸ¥æ˜¯å¦å‘ŠçŸ¥å‰2å°æ™‚ç¦æ°´ (æ­¤æƒ…å¢ƒæ‡‰ç‚º 0)",
        "prompt_template": """
    ä½ ç¾åœ¨çš„ä»»å‹™æ˜¯åˆ¤æ–·ä»¥ä¸‹å°è©±ç´€éŒ„
    å­¸å“¡æ˜¯å¦æœ‰æ˜ç¢ºå‘ŠçŸ¥ å¾æª¢æŸ¥å‰2å€‹å°æ™‚å‰é–‹å§‹ç¦æ°´
        
    [å°è©±ç´€éŒ„]: {conversation_context}
        
    ç¬¦åˆè¼¸å‡º "1"ï¼Œä¸ç¬¦åˆæˆ–æœªæåŠè¼¸å‡º "0" ä¸è¦è¼¸å‡ºé™¤äº†æ•¸å­—ä»¥å¤–çš„æ–‡å­—
"""
    },
    {
        "key": "general_check_time_calculation",
        "title": "æ¸¬è©¦ 3: ä¸€èˆ¬æª¢æŸ¥æƒ…å¢ƒè¨ˆç®— (10é»æª¢æŸ¥ -> 7é»ç¦æ°´)",
        "description": "æª¢æŸ¥æ˜¯å¦å‘ŠçŸ¥ç•¶å¤©æ—©ä¸Š7é»é–‹å§‹ç¦æ°´",
        "prompt_template": """
    æƒ…å¢ƒ å‡è¨­æª¢æŸ¥æ™‚é–“åœ¨æ—©ä¸Š10é»
    ä½ ç¾åœ¨çš„ä»»å‹™æ˜¯åˆ¤æ–·ä»¥ä¸‹å°è©±ç´€éŒ„
    å­¸å“¡æ˜¯å¦æœ‰æ˜ç¢ºå‘ŠçŸ¥ å¾"æª¢æŸ¥ç•¶å¤©æ—©ä¸Š7é»é–‹å§‹ç¦æ°´"
    è¦æ³¨æ„æ˜¯åœ¨ "æª¢æŸ¥ç•¶å¤©" è€Œä¸æ˜¯å…¶ä»–æ—¥å­
        
    [å°è©±ç´€éŒ„]: {conversation_context}
        
    ç¬¦åˆè¼¸å‡º "1"ï¼Œä¸ç¬¦åˆæˆ–æœªæåŠè¼¸å‡º "0" ä¸è¦è¼¸å‡ºé™¤äº†æ•¸å­—ä»¥å¤–çš„æ–‡å­—
"""
    },
    {
        "key": "painless_check_time_calculation",
        "title": "æ¸¬è©¦ 4: ç„¡ç—›æª¢æŸ¥æƒ…å¢ƒè¨ˆç®— (10é»æª¢æŸ¥ -> 8é»ç¦æ°´)",
        "description": "æª¢æŸ¥æ˜¯å¦å‘ŠçŸ¥ç•¶å¤©æ—©ä¸Š8é»é–‹å§‹ç¦æ°´ (æ­¤æƒ…å¢ƒæ‡‰ç‚º 0)",
        "prompt_template": """
    æƒ…å¢ƒ å‡è¨­æª¢æŸ¥æ™‚é–“åœ¨æ—©ä¸Š10é»
    ä½ ç¾åœ¨çš„ä»»å‹™æ˜¯åˆ¤æ–·ä»¥ä¸‹å°è©±ç´€éŒ„
    å­¸å“¡æ˜¯å¦æœ‰æ˜ç¢ºå‘ŠçŸ¥ å¾"æª¢æŸ¥ç•¶å¤©æ—©ä¸Š8é»é–‹å§‹ç¦æ°´"
    è¦æ³¨æ„æ˜¯åœ¨ "æª¢æŸ¥ç•¶å¤©" è€Œä¸æ˜¯å…¶ä»–æ—¥å­
        
    [å°è©±ç´€éŒ„]: {conversation_context}
        
    ç¬¦åˆè¼¸å‡º "1"ï¼Œä¸ç¬¦åˆæˆ–æœªæåŠè¼¸å‡º "0" ä¸è¦è¼¸å‡ºé™¤äº†æ•¸å­—ä»¥å¤–çš„æ–‡å­—
"""
    }
]

async def run_npo_timing_tests():
    print(f"ğŸš€ é–‹å§‹åŸ·è¡Œ NPO ç¦æ°´æ™‚é–“é‚è¼¯æ¸¬è©¦")
    print(f"ğŸ¤– ä½¿ç”¨æ¨¡å‹: {MODEL_NAME}")
    print("=" * 60)
    print(f"ğŸ“„ æ¸¬è©¦å°è©±æƒ…å¢ƒè¨­å®š: ä¸€èˆ¬æª¢æŸ¥ | æ—©ä¸Š10é» | æ‡‰æ–¼æ—©ä¸Š7é»ç¦æ°´")
    print("-" * 60)

    results = {}

    for check in CHECK_LIST:
        print(f"æ­£åœ¨åŸ·è¡Œ: {check['title']} ...", end="\r")

        # çµ„åˆ Prompt
        full_prompt = check["prompt_template"].format(conversation_context=TEST_CONTEXT)

        # å‘¼å« LLM
        try:
            response = await generate_llm_response(full_prompt, model_name=MODEL_NAME)
            result = response.strip()
        except Exception as e:
            result = "Error"
            print(f"\nâŒ æ¨¡å‹å‘¼å«å¤±æ•—: {e}")

        results[check["key"]] = result

        # åˆ¤æ–·çµæœæ˜¯å¦ç¬¦åˆé æœŸ
        # åœ¨æ­¤å°è©±æƒ…å¢ƒä¸‹ï¼š
        # ä¸€èˆ¬æª¢æŸ¥ (Test 1, 3) æ‡‰è©²æ˜¯ "1"
        # ç„¡ç—›æª¢æŸ¥ (Test 2, 4) æ‡‰è©²æ˜¯ "0"
        
        is_general = "general" in check["key"]
        expected = "1" if is_general else "0"
        
        status_icon = "âœ…" if result == expected else f"âš ï¸ (é æœŸ {expected} ä½†å¾—åˆ° {result})"

        print(f"{check['title']}: [{result}] {status_icon}")

    print("=" * 60)
    print("ğŸ“Š æ¸¬è©¦ç¸½çµ:")
    print("ç”±æ–¼å°è©±å…§å®¹æ˜¯ã€Œä¸€èˆ¬æª¢æŸ¥(3hr) + æ—©ä¸Š10é»ã€ï¼Œ")
    print("æ­£ç¢ºé‚è¼¯æ‡‰ç‚ºï¼šæ¸¬è©¦1èˆ‡æ¸¬è©¦3 å›å‚³ '1'ï¼Œæ¸¬è©¦2èˆ‡æ¸¬è©¦4 å›å‚³ '0'ã€‚")

if __name__ == "__main__":
    if os.name == "nt":
        asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())

    asyncio.run(run_npo_timing_tests())