先來回顧整個流程
前端登入介面 -> 註冊介面 -> 送出註冊帳號請求
後端接收註冊帳號請求->post(register)->創建新使用者 新增一筆資料->回傳註冊成功訊息給前端
前端回到登入介面 -> 送出登入請求 
後端接收登入請求 -> post(login) -> 驗證登入 -> 回傳登入成功或失敗

前端進到mainpage(APPSideBar、ModeSelectionView)

分隔點1
ModeSelectionView -> 選擇難度與模式 -> 開始實戰 -> chat.js startChat-> fetchAgentSetting
-> 取得Agent設定後跳轉到ChatView.vue

在ChatView -> 按下麥克風 -> startRecording -> 完全錄完音並轉為TTS -> 送到後端



癥結點
在語音對話 以chatgpt來說 他是一顆球 只要你說話就有外層特效在震動
在prompt中 加入保可淨 跟作用 搞不好可以解決STT問題

待完成的部分

對話中的總結內容減少token

'''輸入內容的部分 如果離題了要阻斷 前端傳送訊息過去之後 就分岔同時 一支產生回應 一支判斷是否離題
等到兩隻都好了之後 假設離題就固定輸出"您的內容偏離主題 請聚焦在衛教內容上"'''

STT輸入要改成whisper-large

前端透過VAD 切片音檔傳回後端 大小大約是200ms
每次都傳200ms 在後端可以透過webrtcvad去刪除沒有人聲部分 將所有文字轉錄好之後 就能夠將回答轉送入LLM中 
chatgpt在做語音交互有可能是 前端會分段傳送語音訊息至後端 後端也會分段去轉譯/一次轉譯整段
接著是送入LLM的方式 只有一種 就是轉譯完整段文字後 才送入LLM 分段送入LLM會導致資源消費過高
生成TTS的方式大致要透過 當我LLM生成到一個小段落(， 。 、 ? !)在標點符號出來之後 就可以送入TTS生成
然後就要確定 使用的TTS有沒有分段送入的功能 沒有的話大概要自己寫 寫的東西就會是chunking＋prosody預測

### 前端或後端做 chunking → 2. 自動插 SSML → 3. 呼叫支援 SSML 的 TTS streaming

在修正之前 應該先修正summary部分 透過summary部分 除了總和過去紀錄之外
就是在語音傳送過來之後 就讓任務分岔 也可以順便做評分

summary的部分(LLM2)要跟 回應用LLM1 做分岔

最後總清算總結 (LLM3)

整體的流程會是分段音檔 送入後端 語音轉文字 全部轉完後 送到LLM
(此處分岔)
LLM1 用來回應當前訊息 LLM2

在scoring_criteria中
要處理"item": "能判斷病人是否有”特殊藥物”"
這個要把所有藥物種類的回答都放入
不對 這項不該在 在scoring_criteria中
這個應該要先額外寫一個function 先透過Agent_setting中的 med_code
去選擇標準答案會是什麼 
    {
        "id": "clinical_judgment_special_med_handle",
        "category": "臨床判斷",
        "item": "能依病人狀況正確說明”特殊藥物”是否需停藥或續用",
        "weight": 1.5,
        "type": "RAG_LLM_KNOWLEDGE_ACCURACY",
        "context_needed": ["med_info"],
        "example_questions": ["這個藥我還能繼續吃嗎？", "特殊藥物停藥時間怎麼說？"]
    }

那些範例答案偏長的都要進行一項一向 測試 不過這可以在之後測試時有問題在處理

在整輪對話結束之後會去用程式統計每個大類別的分數
在這時候會需要去取出在對話中每個項目的分數進行統計
所以這邊就可以去進行評分項目細項的統計

評分的時候 
有一個需要特殊處理 處理方式是再scoring.py
proper_guidance_s2 假設達成 那proper_guidance_s3也會達成 

說明藥物使用時機及方式 可以透過med_usage_timing_method.s1 + med_usage_timing_method.s2

第一階段應該先獲取這個評分項目是在哪次的使用者輸入完成的就好

老實說目前的評分處理方式 已經是我目前能想到的最優解了 只是目前還有非常多需要調整的地方
這東西實在是沒甚麼規律 很難說每次評出來都能得到正確的結果


最後是要處理結算頁面要多放使用者語音 + AI生成語音

### 12/23 目前還要做的
前端結算頁面 設計一個表格樣的
評分項目(實際) 評分細項(程式) 

如果說因為之後還會加入腸見淨以及其他像是抗凝血劑
那資料庫以及程式的共容性要怎麼處理 感覺有點難想
那就是按照原定計劃 新建立一個測試用的程式
有沒有辦法設定一個像是環境變數的

另外再寫一份程式
就是開給他們做測試之後
從資料庫裡面 把他們的資料讀出來 做成excel 然後丟給他們 我這裡也保存一份

要在多一份程式
是我自己用來測試的 基本上就是可以直接查詢所有的紀錄的介面

0115
我還要寫一個備份程式
要備份的東西包括藥師他們的測試紀錄
以及他們測試的音檔

0125
這次就是要在前端score summary view 裡面 加入音檔播放了
這個藥師的說話方式對語音辨識超級不友善 難度挺高
再來就是要寫個自動測試程式
要從human_test.db讀取音檔開始 選定sessionid session_1769303919499_tgpqudkp2 跟 session_1769305390196_txyscuj5a 根據那個session開始時間的順序 專挑user語音的部分
拿語音再一次丟入whisper 接著換成字之後 這邊就是把整個對話紀錄整理好 就跟其他部分的測試一樣 丟進LLM做評分
方式就是參考run_golden_path_test

0128
搬移環境到server上
在server上架設vllm
github 合併分支
修正scoring criteria 把example answer放一邊
新增一個類似對話 把現在使用者測試的話全部塞進去 提高搜尋準確度

在server 上裝ngrok
