先來回顧整個流程
前端登入介面 -> 註冊介面 -> 送出註冊帳號請求
後端接收註冊帳號請求->post(register)->創建新使用者 新增一筆資料->回傳註冊成功訊息給前端
前端回到登入介面 -> 送出登入請求 
後端接收登入請求 -> post(login) -> 驗證登入 -> 回傳登入成功或失敗

前端進到mainpage(APPSideBar、ModeSelectionView)

分隔點1
ModeSelectionView -> 選擇難度與模式 -> 開始實戰 -> chat.js startChat-> fetchAgentSetting
-> 取得Agent設定後跳轉到ChatView.vue

在ChatView -> 按下麥克風 -> startRecording -> 完全錄完音並轉為TTS -> 送到後端



癥結點
在語音對話 以chatgpt來說 他是一顆球 只要你說話就有外層特效在震動
在prompt中 加入保可淨 跟作用 搞不好可以解決STT問題

待完成的部分

對話中的總結內容減少token

'''輸入內容的部分 如果離題了要阻斷 前端傳送訊息過去之後 就分岔同時 一支產生回應 一支判斷是否離題
等到兩隻都好了之後 假設離題就固定輸出"您的內容偏離主題 請聚焦在衛教內容上"'''

STT輸入要改成whisper-large

前端透過VAD 切片音檔傳回後端 大小大約是200ms
每次都傳200ms 在後端可以透過webrtcvad去刪除沒有人聲部分 將所有文字轉錄好之後 就能夠將回答轉送入LLM中 
chatgpt在做語音交互有可能是 前端會分段傳送語音訊息至後端 後端也會分段去轉譯/一次轉譯整段
接著是送入LLM的方式 只有一種 就是轉譯完整段文字後 才送入LLM 分段送入LLM會導致資源消費過高
生成TTS的方式大致要透過 當我LLM生成到一個小段落(， 。 、 ? !)在標點符號出來之後 就可以送入TTS生成
然後就要確定 使用的TTS有沒有分段送入的功能 沒有的話大概要自己寫 寫的東西就會是chunking＋prosody預測

### 前端或後端做 chunking → 2. 自動插 SSML → 3. 呼叫支援 SSML 的 TTS streaming

在修正之前 應該先修正summary部分 透過summary部分 除了總和過去紀錄之外
就是在語音傳送過來之後 就讓任務分岔 也可以順便做評分

summary的部分(LLM2)要跟 回應用LLM1 做分岔

最後總清算總結 (LLM3)

整體的流程會是分段音檔 送入後端 語音轉文字 全部轉完後 送到LLM
(此處分岔)
LLM1 用來回應當前訊息 LLM2

在scoring_criteria中
要處理"item": "能判斷病人是否有”特殊藥物”"
這個要把所有藥物種類的回答都放入
不對 這項不該在 在scoring_criteria中
這個應該要先額外寫一個function 先透過Agent_setting中的 med_code
去選擇標準答案會是什麼 
    {
        "id": "clinical_judgment_special_med_handle",
        "category": "臨床判斷",
        "item": "能依病人狀況正確說明”特殊藥物”是否需停藥或續用",
        "weight": 1.5,
        "type": "RAG_LLM_KNOWLEDGE_ACCURACY",
        "context_needed": ["med_info"],
        "example_questions": ["這個藥我還能繼續吃嗎？", "特殊藥物停藥時間怎麼說？"]
    }

那些範例答案偏長的都要進行一項一向 測試 不過這可以在之後測試時有問題在處理

在整輪對話結束之後會去用程式統計每個大類別的分數
在這時候會需要去取出在對話中每個項目的分數進行統計
所以這邊就可以去進行評分項目細項的統計

評分的時候 
有一個需要特殊處理 處理方式是再scoring.py
proper_guidance_s2 假設達成 那proper_guidance_s3也會達成 

說明藥物使用時機及方式 可以透過med_usage_timing_method.s1 + med_usage_timing_method.s2

第一階段應該先獲取這個評分項目是在哪次的使用者輸入完成的就好

老實說目前的評分處理方式 已經是我目前能想到的最優解了 只是目前還有非常多需要調整的地方
這東西實在是沒甚麼規律 很難說每次評出來都能得到正確的結果


最後是要處理結算頁面要多放使用者語音 + AI生成語音

### 12/23 目前還要做的
前端結算頁面 設計一個表格樣的
評分項目(實際) 評分細項(程式) 

如果說因為之後還會加入腸見淨以及其他像是抗凝血劑
那資料庫以及程式的共容性要怎麼處理 感覺有點難想
那就是按照原定計劃 新建立一個測試用的程式
有沒有辦法設定一個像是環境變數的

另外再寫一份程式
就是開給他們做測試之後
從資料庫裡面 把他們的資料讀出來 做成excel 然後丟給他們 我這裡也保存一份

要在多一份程式
是我自己用來測試的 基本上就是可以直接查詢所有的紀錄的介面

0115
我還要寫一個備份程式
要備份的東西包括藥師他們的測試紀錄
以及他們測試的音檔

0125
這次就是要在前端score summary view 裡面 加入音檔播放了
這個藥師的說話方式對語音辨識超級不友善 難度挺高
再來就是要寫個自動測試程式
要從human_test.db讀取音檔開始 選定sessionid session_1769303919499_tgpqudkp2 跟 session_1769305390196_txyscuj5a 根據那個session開始時間的順序 專挑user語音的部分
拿語音再一次丟入whisper 接著換成字之後 這邊就是把整個對話紀錄整理好 就跟其他部分的測試一樣 丟進LLM做評分
方式就是參考run_golden_path_test

0128
搬移環境到server上
在server上架設vllm
github 合併分支
修正scoring criteria 把example answer放一邊
新增一個類似對話 把現在使用者測試的話全部塞進去 提高搜尋準確度

0203
整理修正藥師遇到問題
我這邊的問題
那所以要寫的程式就是
在voice_replay_tester.py 
要多寫 根據統計這幾次的對話 判斷錯誤

在評分上
比如說 找到了hydration_and_goal.s1 或 s2

這邊要注意的重點有 分次喝完 2000cc 8杯 每一杯150cc
分成4次去對重點評分

分多段的好處是 使用者可能會分成好幾次講 導致整個對話太長不好判斷

gemma12b 是對簡單的乘法算術完全沒問題 所以在prompt 裡面可以加入算術邏輯試試看

這邊就額外多用幾次LLM評分去做
"""
    你現在的任務是判斷以下對話紀錄
    學員是否明確告知 總共要喝2000cc的水
        
        [對話紀錄]: {conversation_context}
        
    符合輸出 "1"，不符合或未提及輸出 "0" 不要輸出除了數字以外的文字
"""

"""
    你現在的任務是判斷以下對話紀錄
    學員是否有說明 要喝 *8* 杯 *150cc* 的水
    如果學員說的 杯數 * cc數 不等於 2000cc 的話 就是錯
    
    對話紀錄 {學員: 藥粉完全溶解的時間,可能約會有五分鐘在溶解的過程當中,水溫可能會略為升高,這是正常的不用擔心
    病患: 好的，了解。

    學員: 服藥後一小時,也就是晚上的六點,我們可以先準備好2000cc的白開水。
    病患: 好的，了解。

    學員: 那這2000cc的白開水在兩到三個小時內陸續分次的喝完或者我們也可以每15分鐘補充一杯250cc的白開水總共喝六杯}
    
        
    符合輸出 "1"，不符合或未提及輸出 "0" 不要輸出除了數字以外的文字
"""



現在測試結果很明顯了 過多的評分要點 本地模型完全不行
一定要拆分成prompt

"""
        你是一位藥師，請檢查學員對於「水分補充」的衛教是否正確且完整。
        
        [正確標準]: 
        1. 總水量約 2000cc。
        2. 服藥後一小時開始補水
        3. 需要「分次」喝完，例如 *10* 杯 *200cc*。如果學員說的 杯數 * cc數 不等於 2000cc 的話 就是錯
        4. 假設要喝10杯水 那大概就是 (120分鐘 / 10)分鐘 喝一次水 或是 (180分鐘 / 10)分鐘 喝一次水都通用
        5. 水要在兩到三個小時喝完
        [對話紀錄]: {學員: 藥粉完全溶解的時間,可能約會有五分鐘在溶解的過程當中,水溫可能會略為升高,這是正常的不用擔心
    病患: 好的，了解。

    學員: 服藥後一小時,也就是晚上的六點,我們可以先準備好2000cc的白開水。
    病患: 好的，了解。

    學員: 那這2000cc的白開水在兩到三個小時內陸續分次的喝完或者我們也可以每15分鐘補充一杯250cc的白開水總共喝八杯
        
        注意事項
        符合輸出 "1"，不符合或未提及輸出 "0" 並且輸出判斷理由
        """

0211
streamlit 目前顯示的資料太難閱讀了
尤其是詳細項目清單 gemini 沒有理解我想要的東西
我想要的東西是整個評分過程結束之後 把所有跟計分有關的項目都列出來

proper_guidance_s5向病人確認有沒有服用其他藥物
還滿容易沒有被搜到
系統主要有三大類問題
一 whisper 辨識問題
二 向量搜尋問題
三 評分誤導 或是 錯誤問題


0212
需要修正AI agent 回應品質
所以修正方式是 將原本的直接把全部東西塞進去變成
使用向量搜尋上下文
過去對話 改成抓關鍵字搜尋
流程大概是 使用者輸入->抓出關鍵字->搜尋過去對話->將關連分數>0.5的句子塞進來


"""
"你是一個病患，預計在 {check_day_offset} 天後（也就是 {exam_day_str}）要做大腸鏡檢查。今天（{today_str}）你剛拿到醫生開的清腸藥（保可淨），正要向護理師（使用者）請教如何使用及相關衛教事宜。",
"你需要仔細聆聽護理師的衛教內容，並給予簡短、自然的回應","在15個字以內簡潔回答"

---
你的個人資訊如下，請根據這些資訊與學員藥師互動：
- 性別：{agent_settings_dict.get('gender', '未提供')}
- 年齡：{agent_settings_dict.get('age', '未提供')}
- 疾病史：{agent_settings_dict.get('disease', '未提供')}
- 目前用藥：{agent_settings_dict.get('med_info', '未提供')}
- 預計檢查日期：{exam_day_str} ({check_day_offset} 天後)
- 預計檢查時間：{check_time_str}
- 檢查類型：{agent_settings_dict.get('check_type', '未提供')} (實際類型: {actual_check_type})
- 繳交費用：{agent_settings_dict.get('payment_fee', '未提供')}
- 過去使用瀉藥經驗：{agent_settings_dict.get('laxative_experience', '未提供')}
- 是否需要代購低渣飲食：{agent_settings_dict.get('low_cost_med', '未提供')}
---
以下是你們的對話紀錄
{近期對話紀錄}
另外附上可能有關聯的過去對話紀錄
{關聯過去對話}
藥師:{user_text}\n
你:
"""

要整理會需要分成多句說明的評分項目

讓這些需要分成多句說明的評分項目 移到結束session的時候再去評分

然後這樣在使用者體驗上 會枯等滿久的 所以最好顯示 目前進行到哪一部

大概是像這樣慢慢顯示目前系統做到哪裡 優化使用者等待體驗
1. 正在進行剩餘評分項目檢查
2. 開始計算各區分數
3. 正在進行總結
4. 下載對話紀錄以及對話音檔
5. 整理結算頁面